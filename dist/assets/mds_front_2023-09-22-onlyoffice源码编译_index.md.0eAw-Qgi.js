import{_ as s,o as a,c as n,R as e}from"./chunks/framework.lUyD4Cud.js";const v=JSON.parse('{"title":"OnlyOffice源码编译","description":"","frontmatter":{"title":"OnlyOffice源码编译","date":"2023-09-22","categories":["后端"]},"headers":[],"relativePath":"mds/front/2023-09-22-onlyoffice源码编译/index.md","filePath":"mds/front/2023-09-22-onlyoffice源码编译/index.md","lastUpdated":1704444471000}'),p={name:"mds/front/2023-09-22-onlyoffice源码编译/index.md"},t=e(`<p>拥有一个绝佳的网络环境来编译源码是非常重要的，网络能决定编译的99%的问题，第二你需要一个Ubuntu的操作系统。我的编译系统版本为18(官方推荐16.04，其实18也行)，其次你需要在系统上安装最基础的编译环境Python和Git。</p><p><a href="https://helpcenter.onlyoffice.com/installation/docs-community-compile.aspx" target="_blank" rel="noreferrer">Compiling ONLYOFFICE Docs for a local server - ONLYOFFICE</a></p><p>这里的服务器，我推荐使用狗云。</p><p>Python用于编译步骤，Git用于下载源码，其中包括了Onlyoffice的源码和GoogleV8的源码。</p><h2 id="环境准备" tabindex="-1">环境准备 <a class="header-anchor" href="#环境准备" aria-label="Permalink to &quot;环境准备&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo apt-get update</span></span>
<span class="line"><span>sudo apt-get upgrade</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo apt install -y nodejs</span></span>
<span class="line"><span>npm i -g grunt-cli</span></span>
<span class="line"><span>npm i -g pkg</span></span>
<span class="line"><span></span></span>
<span class="line"><span>sudo apt install -y openjdk-11-jdk</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo apt-get install -y python git</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>git clone https://github.com/ONLYOFFICE/build_tools.git</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cd build_tools/tools/linux</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>./automate.py server</span></span></code></pre></div><p>编译时间过长，我建议开一个后台终端来运行</p><p>build.sh</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cd build_tools/tools/linux</span></span>
<span class="line"><span></span></span>
<span class="line"><span>./automate.py server</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>chmod +x build.sh</span></span>
<span class="line"><span>sudo nohup ./build.sh &amp;</span></span></code></pre></div><p>编译完成之后，我们需要对Onlyoffice做功能新增的方案。</p><p>如下：</p><p>突破20个人同时编辑。</p><p>一般一个文档，不能让很多人同时编辑，这会对浏览器的性能造成各种影响。</p><h2 id="_1-修改20人同时编辑功能" tabindex="-1">1.修改20人同时编辑功能 <a class="header-anchor" href="#_1-修改20人同时编辑功能" aria-label="Permalink to &quot;1.修改20人同时编辑功能&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>/server/Common/sources/constants.js</span></span>
<span class="line"><span></span></span>
<span class="line"><span>exports.LICENSE_CONNECTIONS = 20;#将此处修改你想要的连接数</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>/root/build_tools/tools/linux/automate.pybuild_tools_params = [&quot;--branch&quot;, branch,</span></span>
<span class="line"><span>                     &quot;--module&quot;, modules,</span></span>
<span class="line"><span>                     &quot;--update&quot;, &quot;0&quot;, #此处修改为0，否则会覆盖你修改的文件</span></span>
<span class="line"><span>                     &quot;--qt-dir&quot;, os.getcwd() + &quot;/qt_build/Qt-5.9.9&quot;]</span></span></code></pre></div><h2 id="部署运行" tabindex="-1">部署运行 <a class="header-anchor" href="#部署运行" aria-label="Permalink to &quot;部署运行&quot;">​</a></h2><p>安装NGINX, PostgreSQL,RabbitMQ</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo apt-get install -y nginx</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo rm -f /etc/nginx/sites-enabled/default</span></span></code></pre></div><p>新建文件，输入内容</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>touch /etc/nginx/sites-available/onlyoffice-documentserver</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>map $http_host $this_host {</span></span>
<span class="line"><span>  &quot;&quot; $host;</span></span>
<span class="line"><span>  default $http_host;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>map $http_x_forwarded_proto $the_scheme {</span></span>
<span class="line"><span>  default $http_x_forwarded_proto;</span></span>
<span class="line"><span>  &quot;&quot; $scheme;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>map $http_x_forwarded_host $the_host {</span></span>
<span class="line"><span>  default $http_x_forwarded_host;</span></span>
<span class="line"><span>  &quot;&quot; $this_host;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>map $http_upgrade $proxy_connection {</span></span>
<span class="line"><span>  default upgrade;</span></span>
<span class="line"><span>  &quot;&quot; close;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>proxy_set_header Host $http_host;</span></span>
<span class="line"><span>proxy_set_header Upgrade $http_upgrade;</span></span>
<span class="line"><span>proxy_set_header Connection $proxy_connection;</span></span>
<span class="line"><span>proxy_set_header X-Forwarded-Host $the_host;</span></span>
<span class="line"><span>proxy_set_header X-Forwarded-Proto $the_scheme;</span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>  listen 0.0.0.0:80;</span></span>
<span class="line"><span>  listen [::]:80 default_server;</span></span>
<span class="line"><span>  server_tokens off;</span></span>
<span class="line"><span>  rewrite ^\\/OfficeWeb(\\/apps\\/.*)$ /web-apps$1 redirect;</span></span>
<span class="line"><span>  location / {</span></span>
<span class="line"><span>    proxy_pass http://localhost:8000;</span></span>
<span class="line"><span>    proxy_http_version 1.1;</span></span>
<span class="line"><span>  }  </span></span>
<span class="line"><span>}</span></span></code></pre></div><p>创建软链接</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo ln -s /etc/nginx/sites-available/onlyoffice-documentserver /etc/nginx/sites-enabled/onlyoffice-documentserver</span></span></code></pre></div><p>重启Nginx</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo nginx -s reload</span></span></code></pre></div><p>安装数据库</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo apt-get install -y postgresql</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo -i -u postgres psql -c &quot;CREATE DATABASE onlyoffice;&quot;</span></span>
<span class="line"><span>sudo -i -u postgres psql -c &quot;CREATE USER onlyoffice WITH password &#39;onlyoffice&#39;;&quot;</span></span>
<span class="line"><span>sudo -i -u postgres psql -c &quot;GRANT ALL privileges ON DATABASE onlyoffice TO onlyoffice;&quot;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>psql -hlocalhost -Uonlyoffice -d onlyoffice -f ../../out/linux_64/onlyoffice/documentserver/server/schema/postgresql/createdb.sql</span></span></code></pre></div><p>安装RabbitMQ</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo apt-get install -y rabbitmq-server</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cd out/linux_64/onlyoffice/documentserver/</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>mkdir fonts</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>LD_LIBRARY_PATH=\${PWD}/server/FileConverter/bin server/tools/allfontsgen \\</span></span>
<span class="line"><span>  --input=&quot;\${PWD}/core-fonts&quot; \\</span></span>
<span class="line"><span>  --allfonts-web=&quot;\${PWD}/sdkjs/common/AllFonts.js&quot; \\</span></span>
<span class="line"><span>  --allfonts=&quot;\${PWD}/server/FileConverter/bin/AllFonts.js&quot; \\</span></span>
<span class="line"><span>  --images=&quot;\${PWD}/sdkjs/common/Images&quot; \\</span></span>
<span class="line"><span>  --selection=&quot;\${PWD}/server/FileConverter/bin/font_selection.bin&quot; \\</span></span>
<span class="line"><span>  --output-web=&#39;fonts&#39; \\</span></span>
<span class="line"><span>  --use-system=&quot;true&quot;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cd out/linux_64/onlyoffice/documentserver/</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>LD_LIBRARY_PATH=\${PWD}/server/FileConverter/bin server/tools/allthemesgen \\</span></span>
<span class="line"><span>  --converter-dir=&quot;\${PWD}/server/FileConverter/bin&quot;\\</span></span>
<span class="line"><span>  --src=&quot;\${PWD}/sdkjs/slide/themes&quot;\\</span></span>
<span class="line"><span>  --output=&quot;\${PWD}/sdkjs/common/Images&quot;</span></span></code></pre></div><h2 id="运行" tabindex="-1">运行 <a class="header-anchor" href="#运行" aria-label="Permalink to &quot;运行&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cd out/linux_64/onlyoffice/documentserver/server/FileConverter</span></span>
<span class="line"><span></span></span>
<span class="line"><span>LD_LIBRARY_PATH=$PWD/bin NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./converter</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>cd out/linux_64/onlyoffice/documentserver/server/DocService</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./docservice</span></span></code></pre></div>`,47),l=[t];function i(o,c,d,u,h,r){return a(),n("div",null,l)}const b=s(p,[["render",i]]);export{v as __pageData,b as default};
